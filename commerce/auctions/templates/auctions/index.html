{% extends "auctions/layout.html" %}

{% block body %}
    <h1 class="message">{{ message }}</h1>
    {% if cat %}
        <h2 class="title">Active Listings for <b class="blue">{{ cat_name }}</b></h2>
    {% else %}
        <h2 class="title">Active Listings</h2>
    {% endif %}
    <div class="container index">
        <div class="row">
            {% for listing in listings %}
                <div class="col-lg-4 d-flex align-items-stretch">
                    <div class="card grey" style="width: 70rem;">
                        <div class="card-body">
                            <div class="container parent_image_container">
                                <div class="container image_container">
                                    <a href="{% url 'view' listing.id %}">{% if listing.image %}
                                        <a href="{% url 'view' listing.id %}"><img class="card-img-top" src="{{ listing.image.url }}" alt="Broken image">
                                    {% elif listing.image_url %}
                                        <a href="{% url 'view' listing.id %}"><img class="card-img-top" src="{{ listing.image_url }}" alt="Broken image">
                                    {% else %}
                                        <img class="card-img-top" src="/media/no_img.svg" alt="No image">
                                    {% endif %}</a>
                                </div>
                            </div>
                            <h5 class="card-title"><a href="{% url 'view' listing.id %}">{{ listing.name }}</a></h5>
                            <h6 class="card-subtitle mb-2 text-muted">{{ listing.condition }}</h6>
                            <p class="card-text">{{ listing.description }}</p>
                            {% if listing.minimum_bid == None %}
                                <p class="card-text current_bid"><b>Current price: </b><b class="blue">No bids made yet</b> <br> <b>Starting price: {{ listing.starting_bid }}</b></p>
                            {% else %}
                                <p class="card-text current_bid"><b>Current price: </b><b class="blue">{{ listing.current_bid }}</b> <br> <b>Starting price: {{ listing.starting_bid }}</b></p>
                            {% endif %}
                            <p class="card-text">{{ listing.shipping_cost }} shipping</p>
                            <p class="time"> 
                                {% load mathfilters %}
                                {% if listing.time_difference.days == 0 %}
                                    Created {{ listing.time_difference.seconds|div:3600|floatformat:0 }} hours and 
                                    {{ listing.time_difference.seconds|div:60|mod:60|floatformat:0 }} minutes ago.
                                {% elif listing.time_difference.days == 0 and listing.time_difference.seconds|div:3600 == 0 %}
                                    Created {{ listing.time_difference.seconds|div:60|mod:60|floatformat:0 }}minutes ago.
                                {% else %}
                                    Created {{ listing.time_difference.days }} days, 
                                    {{ listing.time_difference.seconds|div:3600|floatformat:0 }} hours and 
                                    {{ listing.time_difference.seconds|div:60|mod:60|floatformat:0 }} minutes ago.
                                {% endif %}
                            </p>
                            {% if request.user.is_authenticated %}
                                <div class="inline d-flex justify-content-end">
                                    {% if cat %}
                                        {% if request.user in listing.user_set.all %}
                                            <form action="{% url "index" cat_name=listing.category %}" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                                                <input type="submit" name="unwatch" class="btn btn-success unwatch" value="Delete From Watchlist">
                                        {% else %}
                                            <form action="{% url "index" cat_name=listing.category %}" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                                                <input type="submit" name="watch" class="btn btn-success watch" value="Add To Watchlist">
                                            </form>
                                        {% endif %}
                                    {% else %}
                                        {% if request.user in listing.user_set.all %}
                                            <form action="{% url "index" %}" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                                                <input type="submit" name="unwatch" class="btn btn-success unwatch" value="Delete From Watchlist">
                                            </form>
                                        {% else %}
                                            <form action="{% url "index" %}" method="POST">
                                                {% csrf_token %}
                                                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                                                <input type="submit" name="watch" class="btn btn-success watch" value="Add To Watchlist">
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %}
                            <a class="inline card-link" href="{% url 'view' listing.id %}">View Listing</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}